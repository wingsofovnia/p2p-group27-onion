# Onion Forwarding Module [![Build Status](https://travis-ci.org/wingsofovnia/p2p-group27-onion.svg?branch=master)](https://travis-ci.org/wingsofovnia/p2p-group27-onion) [![Codacy Badge](https://api.codacy.com/project/badge/Grade/2c08bf6f03634851a5922c88fcd9e3a9)](https://www.codacy.com/app/wingsofovnia/p2p-group27-onion?utm_source=github.com&amp;utm_medium=referral&amp;utm_content=wingsofovnia/p2p-group27-onion&amp;utm_campaign=Badge_Grade)

The Onion Forwarding module is a part of a student project for anonymous and unobservable VoIP application using a P2P architecture. The Onion Forwarder is concerned with forwarding data between peers using [Onion routing](https://en.wikipedia.org/wiki/Onion_routing).

### Onion Forwarder
The Onion Forwarder deals with constructing onion tunnels for tunneling data streams from UI module. At the beginning of each round the Onion Forwarder is requested to start constructing a tunnel with at least two [configurable] intermediate hops which are selected at random by querying RPS, - a Random Peer Sampler.

Tunnel building is done iteratively. A peer O building a tunnel selects the first hop peer H1 at random, then forms an ephemeral session key K1 with the peer using external Onion Authorization module. It then uses K1 to encrypt necessary meta-data to H1 to instruct it to connect to the next hop peer H2 and establish an ephemeral session key K2. K2 is generated by the hostkeys of O and K2, so that H1 does not learn about it i.e. done via Onion Routing.

# Current state
- [x] 1. Continious Integration ([Travis-CI](https://travis-ci.org/wingsofovnia/p2p-group27-onion/))
- [x] 2. Continuous Code Quality ([Codacy (pmdcheck)](https://www.codacy.com/app/wingsofovnia/p2p-group27-onion/dashboard))
- [x] 3. Onion Forwarding (Netty)
- [x] 4. INI config loader (ini4j)
- [x] 5. Onion Forwarding In-Memory Sample
- [x] 6. Remote RPS Client (Netty)
- [x] 7. Onion Forwarding API (Netty, partially - no incoming data notification)
- [ ] 8. Remote Onion Authorizer Client
- [ ] 9. CLI Module Launcher (blocked by 7 & 8)
- [x] 10. Code Coverage Reports
- [x] 11. JavaDoc documentation

# Getting Started
The project is written in Java 8 (tested on 1.8.0_112 and up) and uses Gradle for build management.

## Requirements
The only system requirement for building and using the app is **Java 8** installed. The project includes Gradle wrapper and you don't need standalone Gradle installation to build or run the app.

## Dependencies
Those are dependencies used in the project:
```
Dependencies for source set 'main' (compile):
+--- org.apache.commons:commons-lang3:3.5
+--- commons-codec:commons-codec:1.+ -> 1.10
+--- org.ini4j:ini4j:0.5.+ -> 0.5.4
+--- com.google.guava:guava:22.0
+--- io.netty:netty-all:4.1.11.Final
+--- org.slf4j:slf4j-api:1.7.+ -> 1.7.25
\--- org.slf4j:slf4j-simple:1.7.+ -> 1.7.25

Compile dependencies for source set 'main'.
+--- (include dependencies for source set 'main')
\--- org.projectlombok:lombok:1.16.+ -> 1.16.18

Dependencies for source set 'test':
+--- (include dependencies for source set 'main')
+--- junit:junit:4.12
\--- org.mockito:mockito-all:1.10.+ -> 1.10.19
```

## Building The Project
```
$ git clone https://github.com/wingsofovnia/p2p-group27-onion.git
$ cd p2p-group27-onion
$ ./gradlew clean assemble (> gradlew.bat clean assemble for windows)
```

## JavaDoc
JavaDoc documentation can be generated by running Gradle `javadocs` task.
```
$ ./gradlew clean javadocs
```
Documentation will be available at `build/docs/javadoc/index.html` then.

## Code Coverage
You can check project C0 & C1 coverage percentage and generate Jacoco report by running Gradle `check jacocoTestReport` tasks. Coverage statistics will be displayed after running tests. Coverate report will be available at `build/reports/jacoco/test/html/index.html`.
```
$ ./gradlew clean check jacocoTestReport
....
BUILD SUCCESSFUL
Total time: 14.324 secs
Coverage summary:
onion-forwarding:  61,2%
```

## Running Onion Forward In-Memory Example
There is an example of Netty-based Onion Forward implementation which you can run locally to test data forwarding without required remote Onion Authorizer and RPS. All onion are run locally with in-memory Onion Authorizer and RPS fakes.
```
# Compile
./gradlew clean jar

# Run example
java -jar samples/build/libs/onion-forwarding-samples-0.1-SNAPSHOT.jar ${NUMBER_OF_ONIONS_>3}

# Example output:
$ java -jar samples/build/libs/onion-forwarding-samples-0.1-SNAPSHOT.jar 3
Number of local onions = 3, intermediate hops = 1
Random local peers = localhost/127.0.0.1:16453, localhost/127.0.0.1:6247, localhost/127.0.0.1:39516
Please select origin onion to build a tunnel
0) localhost/127.0.0.1:16453
1) localhost/127.0.0.1:6247
2) localhost/127.0.0.1:39516
Type: 0
Please select destination onion to build a tunnel
1) localhost/127.0.0.1:6247
2) localhost/127.0.0.1:39516
Type: 2
Building the tunnel ...
Listener: Onion (localhost/127.0.0.1:39516) incoming tunnel #909156460
Tunnel #909156460 has been successfully built

Feel free to type any string to forward it from the (localhost/127.0.0.1:16453) -> (localhost/127.0.0.1:39516). Type 'exit' to exit.
> test
Sending "test" from (localhost/127.0.0.1:16453) to (localhost/127.0.0.1:39516) via tunnel #909156460
Listener: Datum "test" arrived to (localhost/127.0.0.1:39516) via tunnel #909156460
> exit
Closing onions ...
$ ...
```

## Course Information
- **University**: [TUM](https://tum.de)
- **Course**: P2PSEC (IN2194)
- **Semester**: Summer 2017

### Team

The Team \#24
 - **Eiler Poulsen** (03692108), Informatics (M.Sc.);
 - **Illia Ovchynnikov** (03692268), Informatics (M.Sc.);

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details
